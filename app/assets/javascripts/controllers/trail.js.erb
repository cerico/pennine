scenic.controller("TrailsController", [ '$scope','$location','$http','$timeout', function($scope,$location,$http,$timeout) {


  $scope.favstate = "notfaved"
  $scope.compstate = "notcompleted"

 $scope.dropzone = Dropzone

  $scope.posthere = $location.path() + '/photos'


 Dropzone.autoDiscover = false;

 //show uploaded photo immediately
    $timeout (function() {

  // console.log(Dropzone.forElement($scope.z))

 //     if (Dropzone.forElement($scope.z)){
 //     Dropzone.forElement($scope.z).destroy();
 //     console.log("destroyed previous")
   
 // }

     console.log("photosjs line 29   " + $scope.posthere)
  

       // var mediaDropzone;
       // $scope.y = "#media-dropzone_" + $route.current.params.id
       console.log($scope.posthere)
       Dropzone.options.photoDropzone = new Dropzone("#media-dropzone", {url: $scope.posthere});
       console.log(Dropzone.options.photoDropzone)
  
       return Dropzone.options.photoDropzone.on("success", function(file, responseText) {
    

         var imageUrl;
         imageUrl = responseText.image.url;
         $http.get($location.path() + '/photos.json').success (function (data){
    
           $scope.well = data
           $scope.photos = data
            Dropzone.options.photoDropzone.removeAllFiles();
         });
         console.log(Dropzone.options.photoDropzone)
         console.log(Dropzone.forElement($scope.z))
       console.log(Dropzone.options.photoDropzone)
       })

    },200);




  $scope.getTrailInfo = function (){
    $http.get($location.path() + '.json').success (function (data){
      $scope.trail = data
     
      $scope.checkHikerBookmark()
     
     
    })
  }

  $scope.getTrailInfo()

  $scope.checkHikerBookmark = function (){

    if  ($scope.trail.hikerbookmark) {
      if ($scope.trail.hikerbookmark.favourited == true) {
        $scope.favstate = "faved"
      }
      else {
        $scope.favstate = "notfaved"
      }
      if ($scope.trail.hikerbookmark.completed == true) {
        $scope.compstate = "completed"
      }
      else {
        $scope.compstate = "notcompleted"
      }
    }
    else{
      $scope.favstate = "notfaved"
      $scope.compstate = "notcompleted"
    }
  } 

  $scope.addFav = function (f){

    var letsBookmark = {}
    letsBookmark.trail_id = $scope.trail.id
    letsBookmark.user_id = $scope.trail.hiker.id

    if (f == 'favit') {
      modit = {favourited: true}
      letsBookmark.favourited = true
    }else if (f == 'unfavit') {
      modit = {favourited: false}

    }else if (f == 'doneit') {
      modit = {completed: true}
      letsBookmark.completed = true

    }else if (f = 'undoneit') {
      modit = {completed: false}

    }




    if ($scope.trail.hikerbookmark) {         
     $http.put('/bookmarks/' + $scope.trail.hikerbookmark.id + '.json', modit).success (function (data){
      $scope.getTrailInfo() 
    });
   }else{      
    $http.post('/bookmarks.json', {bookmark: letsBookmark}).success (function (data){
      console.log(modit)
      $scope.getTrailInfo() 
    })

  } 
}



}])