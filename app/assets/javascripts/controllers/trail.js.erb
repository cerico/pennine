scenic.controller("TrailsController", [ '$scope','$location','$http','uiGmapGoogleMapApi', function($scope,$location,$http,uiGmapGoogleMapApi) {
  $(".angular-google-map-container").css("height", "400px");
  $scope.favstate = "notfaved"
  $scope.compstate = "notcompleted"
  $scope.posthere = $location.path() + '/photos'
  Dropzone.autoDiscover = false;
  



  $scope.averating = function (){
    total = 0
    for (var i= 0; i< $scope.trail.bookmarks.length; i++){
      if ($scope.trail.bookmarks[i].rating > 0) {
        raters = $scope.trail.bookmarks.length;
        total += $scope.trail.bookmarks[i].rating
      }
      $scope.trailrating = total/raters


      if ($scope.trailrating != $scope.trailrating ){
        $scope.trailrating = "Unrated"
      }
    }
  }

  $scope.getTrailInfo = function (){
    $http.get($location.path() + '.json').success (function (data){
      $scope.trail = data  
      if (data.hikerbookmark){
        $scope.changeStar(data.hikerbookmark.rating)
        console.log(data.hikerbookmark.rating)
      }
      $scope.averating();  
      uiGmapGoogleMapApi.then(function(maps) {
        $scope.map = { 
          center: { latitude:$scope.trail.lat, longitude: $scope.trail.lng }, 
          zoom: 13,
          Markers: [({
            latitude: $scope.trail.lat,
            longitude: $scope.trail.lng,
            id: 1,
            draggable:true
          })] ,
        };
      });
      $scope.checkHikerBookmark()    
    })
  }

  $scope.getTrailInfo()




  $scope.photoUpload = function (){
    Dropzone.options.photoDropzone = new Dropzone("#media-dropzone", {url: $scope.posthere,dictDefaultMessage:""} );
    return Dropzone.options.photoDropzone.on("success", function(file, theNewPhoto) {
      $scope.trail.photos.push(theNewPhoto)
      $http.get($location.path() + '/photos.json').success (function (data){
        Dropzone.options.photoDropzone.removeAllFiles();
      });
   })
  }

  $scope.photoUpload()

  $scope.checkHikerBookmark = function (){

    if  ($scope.trail.hikerbookmark) {
      if ($scope.trail.hikerbookmark.favourited == true) {
        $scope.favstate = "faved"
      }
      else {
        $scope.favstate = "notfaved"
      }
      if ($scope.trail.hikerbookmark.completed == true) {
        $scope.compstate = "completed"
      }
      else {
        $scope.compstate = "notcompleted"
      }
    }
    else{
      $scope.favstate = "notfaved"
      $scope.compstate = "notcompleted"
    }
  } 

  $scope.addFav = function (f){

    var letsBookmark = {}
    letsBookmark.trail_id = $scope.trail.id
    letsBookmark.user_id = $scope.trail.hiker.id

    if (f == 'favit') {
      modit = {favourited: true}
      letsBookmark.favourited = true
    }else if (f == 'unfavit') {
      modit = {favourited: false}

    }else if (f == 'doneit') {
      modit = {completed: true}
      letsBookmark.completed = true

    }else if (f == 'undoneit') {
      modit = {completed: false}

    }else  {
      modit = {rating: f}
      letsBookmark.rating = f
 
    }

    if ($scope.trail.hikerbookmark) {         
     $http.put('/bookmarks/' + $scope.trail.hikerbookmark.id + '.json', modit).success (function (data){
      $scope.changeStar(f)
      $scope.getTrailInfo() 
      
    });
   }else{      
    $http.post('/bookmarks.json', {bookmark: letsBookmark}).success (function (data){
      $scope.changeStar(f)
      $scope.getTrailInfo() 
   
    })

  } 
}

$scope.changeStar = function(f) {
  $scope.is5 = false
  $scope.is4 = false
  $scope.is3 = false
  $scope.is2 = false
  $scope.is1 = false
if (f === 1){
  $scope.is1 = true
}
else if (f === 2){
  $scope.is2 = true
  $scope.is1 = true
}
else if (f === 3){
  $scope.is3 = true
  $scope.is2 = true
  $scope.is1 = true
}
else if (f === 4){
 $scope.is4 = true
 $scope.is3 = true
 $scope.is2 = true
 $scope.is1 = true
}
else if (f === 5){
  $scope.is5 = true
  $scope.is4 = true
  $scope.is3 = true
  $scope.is2 = true
  $scope.is1 = true
}


}



}])